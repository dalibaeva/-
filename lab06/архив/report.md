---
# Front matter
lang: ru-RU
title: "Лабораторная работа № 6"
subtitle: "Мандатное разграничение прав в Linux"
author: "Алибаева Данагуль НБибд-01-18"

# Formatting
toc-title: "Содержание"
toc: true # Table of contents
toc_depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a4paper
documentclass: scrreprt
polyglossia-lang: russian
polyglossia-otherlangs: english
mainfont: PT Serif
romanfont: PT Serif
sansfont: PT Sans
monofont: PT Mono
mainfontoptions: Ligatures=TeX
romanfontoptions: Ligatures=TeX
sansfontoptions: Ligatures=TeX,Scale=MatchLowercase
monofontoptions: Scale=MatchLowercase
indent: true
pdf-engine: lualatex
header-includes:
  - \linepenalty=10 # the penalty added to the badness of each line within a paragraph (no associated penalty node) Increasing the value makes tex try to have fewer lines in the paragraph.
  - \interlinepenalty=0 # value of the penalty (node) added after each line of a paragraph.
  - \hyphenpenalty=50 # the penalty for line breaking at an automatically inserted hyphen
  - \exhyphenpenalty=50 # the penalty for line breaking at an explicit hyphen
  - \binoppenalty=700 # the penalty for breaking a line at a binary operator
  - \relpenalty=500 # the penalty for breaking a line at a relation
  - \clubpenalty=150 # extra penalty for breaking after first line of a paragraph
  - \widowpenalty=150 # extra penalty for breaking before last line of a paragraph
  - \displaywidowpenalty=50 # extra penalty for breaking before last line before a display math
  - \brokenpenalty=100 # extra penalty for page breaking after a hyphenated line
  - \predisplaypenalty=10000 # penalty for breaking before a display
  - \postdisplaypenalty=0 # penalty for breaking after a display
  - \floatingpenalty = 20000 # penalty for splitting an insertion (can only be split footnote in standard LaTeX)
  - \raggedbottom # or \flushbottom
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Развить навыки администрирования ОС Linux. Получить первое практическое знакомство с технологией SELinux. Проверить работу SELinx на практике совместно с веб-сервером Apache.

# Задание

1. Войти в систему с полученными учётными данными и убедится, что SELinux работает в режиме enforcing политики targeted.

2. Обратится с помощью браузера к веб-серверу, запущенному на компьютере, и убедится, что последний работает. Если не работает, запустить его так же, но с параметром start. 

3. Найти веб-сервер Apache в списке процессов, определить его контекст безопасности и занести эту информацию в отчёт. 

4. Посмотреть текущее состояние переключателей SELinux для Apache. Обратить внимание, что многие из них находятся в положении «off».

5. Посмотреть статистику по политике с помощью команды seinfo, также определить множество пользователей, ролей, типов. 

6. Определить тип файлов и поддиректорий, находящихся в директории /var/www.

7. Определить тип файлов, находящихся в директории /var/www/html.

8. Определить круг пользователей, которым разрешено создание файлов в директории /var/www/html. 

9. Создать от имени суперпользователя (так как в дистрибутиве после установки только ему разрешена запись в директорию) html-файл /var/www/html/test.html следующего содержания: Test

10. Проверить контекст созданного файла. Занести в отчёт контекст, присваиваемый по умолчанию вновь созданным файлам в директории /var/www/html. 

11. Обратиться к файлу через веб-сервер, введя в браузере адрес http://127.0.0.1/test.html. Убедится, что файл был успешно отображён. 

12. Изучить справку man httpd_selinux и выяснить, какие контексты файлов определены для httpd. Сопоставить их с типом файла test.html. 

13. Изменить контекст файла /var/www/html/test.html с httpd_sys_content_t на любой другой, к которому процесс httpd не должен иметь доступа, например, на samba_share_t. После этого проверить, что контекст поменялся. 

14. Попробовать ещё раз получить доступ к файлу через веб-сервер, введя в браузере адрес http://127.0.0.1/test.html. Должны получить сообщение об ошибке: Forbidden You don't have permission to access /test.html on this server. 

15. Проанализировать ситуацию. Почему файл не был отображён, если права доступа позволяют читать этот файл любому пользователю? Просмотреть log-файлы веб-сервера Apache. Также просмотреть системный лог-файл. Если в системе окажутся запущенными процессы setroubleshootd и audtd, то можно увидеть ошибки, аналогичные указанным выше, в файле /var/log/audit/audit.log. 

16. Попробовать запустить веб-сервер Apache на прослушивание ТСР-порта 81 (а не 80, как рекомендует IANA и прописано в /etc/services). Для этого в файле /etc/httpd/httpd.conf найти строчку Listen 80 и заменить её на Listen 81. 

17. Выполнить перезапуск веб-сервера Apache. Произошёл сбой? Пояснить почему? 

18. Проанализирвать лог-файлы. Просмотреть файлы /var/log/http/error_log, /var/log/http/access_log и /var/log/audit/audit.log и выяснить, в каких файлах появились записи. 

19. Проверить список портов. Убедиться, что порт 81 появился в списке. 

20. Попробовать запустить веб-сервер Apache ещё раз.

21. Вернуть контекст httpd_sys_cоntent__t к файлу /var/www/html/ test.html. После этого попробовать получить доступ к файлу через веб-сервер. Должны увидеть содержимое файла — слово «test». 

22. Исправить обратно конфигурационный файл apache, вернув Listen 80.

23. Удалить привязку http_port_t к 81 порту и проверить, что порт 81 удалён. 

24. Удалить файл /var/www/html/test.html.

# Теоретическое введение

В Linux дискреционные механизмы разграничения доступа (DAC, discretionary access control) являются основными и всегда активны. Их использование предполагает, что владельцы объектов правильно распоряжаются правами доступа к находящимся в их владении объектам. [1]

Например, пользовательские закрытые ключи, используемые службой W:[SSH], в каталоге ~/.ssh или ключи W:[GnuPG] в каталоге ~/.gnupg, и прочие секретные данные (подобные ключи доступа в банковские информационные системы)- должны быть недоступны никому, кроме их владельца. Запускаемые пользователем программы выполняются от лица запустившего их пользователя и имеют доступ к файлам согласно установленным режимам или спискам доступа. [1]

В примере из листинга ниже клиент ssh, браузер firefox и коммуникатор skype имеют абсолютно равные возможности по чтению и модификации пользовательского закрытого ключа ~/.ssh/id_rsa, тогда как настоящим «владельцем» ключей является только ssh. [1]

Абсолютно естественно предполагать, что программы firefox и skype не имеют никаких намерений доступа к пользовательским ключам SSH. [1]

Можно даже доверять программе firefox, штатно установленной из доверенного источника (дистрибутива), где она была изготовлена из открытых исходных текстов, подлежащих верификации. Однако нет никаких оснований доверять закрытому skype, поставляемому в бинарном виде.[1]

Более того, предоставлять доступ программам firefox и skype к SSH-ключам пользователя нет никакой необходимости, во-первых, просто потому, что это выходит за рамки набора минимально необходимых условий их целевого функционирования. [1]

Во-вторых, практически в любой программе есть ошибки, используя которые злоумышленник может осуществлять непреднамеренные действия в свою пользу. Таким воздействиям особенно подвержены программы, использующие сетевой обмен с недоверенной внешней средой — клиенты и серверы сетевых служб операционной системы. [1]

Тем временем, дискреционный подход и механизмы служат для разграничения доступа разных пользователей к файлам, но никак не предназначены для разграничения доступа программ одного и того же пользователя к разным файлам этого пользователя. [1]

Для разграничения доступа субъектов — программ к объектам — файлам дерева каталогов используют так называемый мандатный (от англ, mandatory — обязательный или принудительный) подход (MAC, mandotary access control), предполагающий следование обязательным правилам доступа к файлам, назначаемым администраторами системы. [1]

Правила доступа строятся на основе знания о внутреннем устройстве программ и представляют собой описание набора минимально необходимых условий их целевого функционирования. [1]

Таким образом, в мандатных правилах, ограничивающих доступ к SSH-ключам пользователя, только программе ssh должен быть разрешен доступ для непосредственного выполнения своих прямых функций, а программам firefox и skype в доступе к SSH-ключам должно быть отказано. [1]

# Выполнение лабораторной работы

1.Лабораторная работа выполнялась дома со следующими характеристиками техники: 

– Intel(R) Core(TM) i5-8300H CPU @ 2.30GHz, 2304 МГц, ядер: 4, логических процессоров: 8

– ОС Майкрософт Windows 10 Pro

– VirtualBox верс. 6.1.26

2.	Вошла в систему с полученными учётными данными и убедилась, что SELinux работает в режиме enforcing политики targeted с помощью команд getenforce (рис 1.1) и sestatus (рис 1.2). 

![1.1. SELinux в режиме enforcing](image/1_1.png){ #fig:001 width=70% }

![1.2. Политика targeted](image/1_2.png){ #fig:002 width=70% }

3.	Обратилась с помощью браузера к веб-серверу, запущенному на компьютере, и убедилась, что последний работает: service httpd status или /etc/rc.d/init.d/httpd status (рис 1.3), (рис 1.4).
 
![1.3. Обращение к веб-серверу](image/1_3.png){ #fig:003 width=70% }

![1.4. Обращение к веб-серверу (2) ](image/1_4.png){ #fig:004 width=70% }

4.	Нашла веб-сервер Apache в списке процессов, определила его контекст безопасности и занесла эту информацию в отчёт с помощью команды ps auxZ | grep httpd или ps -eZ | grep httpd (рис 1.5). 

![1.5. Занесение контекста в отчет](image/1_5.png){ #fig:005 width=70% }

5.	Посмотрела текущее состояние переключателей SELinux для Apache с помощью команды sestatus -bigrep httpd. Обратила внимание, что многие из них находятся в положении «off» (рис 1.6). 

![1.6. Просмотр текущего состояния переключателей](image/1_6.png){ #fig:006 width=70% }

6.	Посмотрела статистику по политике с помощью команды seinfo, также определила множество пользователей, ролей, типов. (рис 1.7).

![1.7. Просмотр статистики](image/1_7.png){ #fig:007 width=70% }

7.	Определила тип файлов и поддиректорий, находящихся в директории /var/www, с помощью команды ls -lZ /var/www  (рис 1.8). 

![1.8. Определение типа файлов и поддиректорий ](image/1_8.png){ #fig:008 width=70% }

8.	Определила тип файлов, находящихся в директории /var/www/html: ls -lZ /var/www/html (рис 1.9).

![1.9. Определение типа файлов ](image/1_9.png){ #fig:009 width=70% }

9.	Создала от имени суперпользователя (так как в дистрибутиве после установки только ему разрешена запись в директорию) html-файл /var/www/html/test.html (рис 1.10)

![1.10. Создание html-файла](image/1_10.png){ #fig:010 width=70% }

10.	Проверила контекст созданного файла. Занесла в отчёт контекст, присваиваемый по умолчанию вновь созданным файлам в директории /var/www/html. (рис 1.11). 

![1.11. Проверка контекста созданного файла](image/1_11.png){ #fig:011 width=70% }

11.	Обратилась к файлу через веб-сервер, введя в браузере адрес http://127.0.0.1/test.html. Убедилась, что файл был успешно отображён. (рис 1.12).

![1.12. Обращение к файлу через веб-сервер](image/1_12.png){ #fig:012 width=70% }

12.	Изучила справку man httpd_selinux и выяснила, какие контексты файлов определены для httpd с помощью команды ls -Z. ls -Z /var/www/html/test.html. Сопоставила их с типом файла test.html (рис 1.13), (рис 1.14).

![1.13. Справка selinux](image/1_13.png){ #fig:013 width=70% }

![1.14. Определение контекстов файлов](image/1_14.png){ #fig:014 width=70% }

13.	Изменила контекст файла /var/www/html/test.html с httpd_sys_content_t на samba_share_t: chcon -t samba_share_t /var/www/html/test.html ls -Z /var/www/html/test.html (рис 1.15).

![1.15. Изменение контекста файла](image/1_15.png){ #fig:015 width=70% }

14.	Попробовала ещё раз получить доступ к файлу через веб-сервер, введя в браузере адрес http://127.0.0.1/test.html. Получила сообщение об ошибке: Forbidden You don't have permission to access /test.html on this server. (рис 1.16). 

![1.16. Получение сообщения об ошибке](image/1_16.png){ #fig:016 width=70% }

15.	Проанализировала ситуацию. Просмотрела log-файлы веб-сервера Apache. Также просмотрела системный лог-файл: tail /var/log/messages. (рис 1.17), (рис 1.18).

![1.17. Просмотр системного лог-файла](image/1_17.png){ #fig:017 width=70% }

![1.18. Просмотр системного лог-файла (2)](image/1_18.png){ #fig:018 width=70% }

16.	Попробовала запустить веб-сервер Apache на прослушивание ТСР-порта 81 (а не 80, как рекомендует IANA и прописано в /etc/services). Для этого в файле /etc/httpd/httpd.conf нашла строчку Listen 80 и заменила её на Listen 81. (рис 1.19), (рис 1.20).

![1.19. Замена строчки Listen 80](image/1_19.png){ #fig:019 width=70% }

![1.20. Запуск веб-сервера Apache](image/1_20.png){ #fig:020 width=70% }

17.	Проанализировала лог-файлы: tail -nl /var/log/messages (рис 1.21). Просмотрела файлы /var/log/http/error_log, /var/log/http/access_log (рис 1.22) и /var/log/audit/audit.log и выяснила, в каких файлах появились записи. (рис 1.23).

![1.21. Анализ лог-файла messages](image/1_21.png){ #fig:021 width=70% }

![1.22. Просмотр файлов error_log и access_log](image/1_22.png){ #fig:022 width=70% }

![1.23. Просмотр файла audit.log](image/1_23.png){ #fig:023 width=70% }

18.	Выполнила команду semanage port -a -t http_port_t -р tcp 81 (рис 1.24). После этого проверила список портов командой semanage port -l | grep http_port_t. Убедилась, что порт 81 появился в списке. (рис 1.25).

![1.24. Выполнение команды semanage](image/1_24.png){ #fig:024 width=70% }

![1.25. Проверка списка портов](image/1_25.png){ #fig:025 width=70% }

19.	Вернула контекст httpd_sys_cоntent__t к файлу /var/www/html/ test.html: chcon -t httpd_sys_content_t /var/www/html/test.html (рис 1.26). После этого попробовала получить доступ к файлу через веб-сервер, введя в браузере адрес http://127.0.0.1:81/test.html (рис 1.27).

![1.26. Возвращение контекста](image/1_26.png){ #fig:026 width=70% }

![1.27. Получение доступа к веб-серверу](image/1_27.png){ #fig:027 width=70% }

20.	Исправила обратно конфигурационный файл apache, вернув Listen 80 (рис 1.28).

![1.28. Исправление конфигурационного файла](image/1_28.png){ #fig:028 width=70% }

21.	Удалила привязку http_port_t к 81 порту: semanage port -d -t http_port_t -p tcp 81 и проверила, что порт 81 удалён.  (рис 1.29). 

![1.29. Удаление привязки к порту](image/1_29.png){ #fig:029 width=70% }

22.	Удалила файл /var/www/html/test.html: rm /var/www/html/test.html (рис 1.30). 

![1.30. Удаление файла](image/1_30.png){ #fig:030 width=70% }

# Выводы

Развила навыки администрирования ОС Linux. Получила первое практическое знакомство с технологией SELinux. Проверила работу SELinx на практике совместно с веб-сервером Apache. 

# Список литературы 

1.	Мандатное разграничение прав в Linux// URL: https://debianinstall.ru/mandatnoe-prinuditelnoe-razgranichenie-dostupa-linux/ (дата обращения: 26.11.2021).